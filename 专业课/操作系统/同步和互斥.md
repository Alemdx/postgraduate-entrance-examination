# 同步和互斥

[TOC]

## 同步与互斥的基本概念

### 临界资源

同时只能有一个进程进行访问

### 同步

表现为一种协作的关系。有一定的工作次序

### 互斥

是一种制约的关系。A访问B就不能访问

## 进程互斥的软件实现方法

### 为什么要进行互斥访问？

比如说A在使用打印机，A打到一般就被叫停了。这时B进行打印，这样打印的内容就混掉了。因此我们必须保证A能一口气打印完。

### 单标志法

**使用一个turn表示当前允许哪个进程访问临界区**

在退出区把使用权转让给别人。但是如果别人一直不使用，自己也没法使用。违反了（空闲让进）的原则。

### 双标志先检查

用flag表示是否想要访问临界区。

进入临界区的条件**是对方不想进入临界区。**

如果自己进入了临界区，就把自己的flag设置为true。退出就设为false。

**但是并发运行时会出现问题。违反了忙则等待的原因。（检查和上锁的过程不能一气呵成）**

### 双标志后检查

先上锁表示自己想访问临界区。在查看对方是否在访问临界区。

但是会出现双方都在等待的情况，出现饥饿。违背了“空闲让进“的原则

### Peterson算法

单标志法和双标志法相结合。

+ **先表达自己想要使用资源**
+ **再表示自己愿意谦让给对方**
+ 如果是对方想用，且最后是自己表达了谦让。就一直等待。

这里可以与现实生活联系起来。

## 进程互斥的硬件实现方法

### 中断屏蔽方法

+ 使用开关中断指令进行实现。

+ 关中断之后就无法进行进程切换，就会一直享有该资源。
  + 但是多处理机情况下不能实现

### TSL指令

是由硬件实现的

检查和上锁是一气呵成的。（解决了双标志法的异步问题）

适用于多处理机

### SWAP指令

和tsl差不多

## 信号量机制

+ 就是一种变量。（整数或记录型）
+ 用来表示系统某种资源的数量。
+ 使用原语来对信号量进行操作（PV）
  + PV本身是一种原语，但是PV之间的不是原语

### 整型信号量

用一个整型数量的变量作为信号量。表示某种资源的数量。只能进行初始化、P、V操作

PV是原语操作，可以一气呵成，就避免的异步问题。

### 记录型信号量（能实现阻塞）

对信号量进行一次P操作意味着进程请求一个单位的该类资源，value的值--。当value的值小于0时，则表示该资源已经分配完毕。**该进程调用block原语进行自我阻塞**（从运行态到阻塞态，这也就解释了阻塞为什么是一个阻塞的过程），放弃了处理机调度，从而**实现了“让权等待”。**

+ -n表示有n个在阻塞队列中

## 使用信号量机制实现进程的同步与互斥

### 互斥

+ 划定临界区
+ **设置互斥型号量mutex，初值为1**
  + 互斥量表示的是一种资源，这里设置为1我们可以认为是进入临界区的名额
+ 临界区之前进行P，临界区之后进行V操作。

### 同步

+ 让各个并发的程序按要求的有序的推进
+ 分析同步关系，执行的先后顺序
+ **设置同步信号量S为0**
+ 前V后P。前面做完了通过V释放资源。使用前使用P申请资源

进程的前驱关系

## 管程

程序员在写函数的时不需要如何考虑互斥。这是有编译器负责实现的。

+ 定义共享数据
+ 定义访问数据的入口
+ **管程每次只能让一个进程访问入口。**

## 生产者消费者问题

缓冲区没满，生产者生产

缓冲区没空，消费者消费

缓冲区是临界资源，各个进程必须互斥访问。不然的话可能会产生诸如数据覆盖的问题。

**注意这里P的操作顺序不能乱。但是V的操作可以乱。**

**这是两对不同的同步关系。**

## 多生产者多消费者问题

互斥关系：
对缓冲区（盘子）的访问要互斥的进行 （盘子容量为1）

同步关系（一前一后）：

1. 父亲将苹果放入盘子后，女儿才能取苹果
2. 母亲将橘子放入盘子后，儿子才能取橘子
3. 只有盘子为空时，父亲或母亲才能放入水果

注意：

1. 在这道题中，可以不设置专门的互斥变量mutex，也不会出现多个进程同时访问盘子的现象。原因在于：**本题中缓冲区大小为1，在任何时刻，其余三个信号量最多只有一个是1。**因此在任何时刻，最多只有一个进程P操作不会被阻塞，并顺利的进入临界区。
2. 我们要尝试从事件的角度来考虑而不是从进程的角度来考虑。
   1. 我个人理解为，对具体的操作（函数）进行分解，而不是对进程进行分解
      1. 为名词设置信号量而不是动作？

## 吸烟者问题

单生产者，多消费者

## 读者写者问题

一个文件，多个读者，多个写者。

多个同时读

最多一个写

写的时候其余的都退出

**写与写互斥，写与读互斥，读和读不存在互斥。**

### 主要问题

如果实现读写互斥的同时，实现读者之间同步？

答：使用count记录读者的数量。**由第一个读进程负责加锁，由最后一个读进程负责解锁。**不同的读进程之间，互斥访问count。

### 为什么要对count实现互斥访问？

如果两个进程并发执行，当Count值都为0时，两个进程的if条件语句都会执行，这样P就会执行两次，导致另一个进程阻塞的情况

## 哲学家就餐问题

+ 每个哲学家需要拿起两个临界资源

+ 使用数组定义五个互斥信号量
+ 五个哲学家都同时拿起自己的筷子就会发生死锁的现象。
  + 我们约定**最多只有四个哲学家同时进餐**。
  + 约定奇数号先拿左边的筷子，再去拿右边的筷子。偶数号相反。这两如果有两个相邻的哲学家想吃饭，会有一个直接被阻塞。

实现方法：

保证哲学家这拿起两只筷子的过程不被打断。

## 问题

**需要特别考量，互斥量加的位置。**