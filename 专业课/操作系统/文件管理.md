[TOC]

# 写在前面

用户可以和操作系统直接交互，是通过什么样的方式。

我们常用的命令行到底是什么

# 文件系统基础

+ 标识符能唯一表示一个文件，文件名不行
+ 文件可以分为无结构文件和有结构文件
+ 调用系统调用（创建删除读写打开关闭）

## 文件的存储结构

+ 逻辑地址可以分为（逻辑块号+块内地址）。操作系统需要将逻辑地址转化为物理地址（物理块号+块内地址）
+ **文件以块为单位进行分配。**
+ 物理上可以是离散的

## 文件目录

+ FCB的有序集合称为“文件目录”。一个FCB就是一个文件目录项。

+ FCB包含了文件的基本信息（**文件名、物理地址**、逻辑结构、物理结构、权限等）
+ 树形目录结构不适合文件的共享
+ 有向无环图目录结构
  + 建立在树形结构之上，增加某些指向同一结点的有向边
  + 不同名的文件指向同一个文件

## 文件共享

区分共享与复制

### 硬链接（基于索引结点的共享方式）

索引结点，其实就是把FCB中除了文件名的其他信息放到一个索引结点中。进行瘦身罢了。

一个用户删除文件时并不会完全把这个文件给删除掉。只有当索引结点中count（表示链接到该结点的目录项的数目）为0时才彻底删掉了

### 软连接（基于符号链的共享方式）

并不是直接把自己的链接指向那个结点。而是创建了一个link型的文件，link中存放的文件的路径。**类似于win中的快捷方式**。

只有文件主才拥有指向其结点的指针。

## 文件系统的层次结构



# 文件的基本操作

## 创建文件

调用`create`系统调用

参数：

+ 外存空间大小
+ 文件存放路径
+ 文件名

## 删除文件

系统调用`delete`

参数：

+  文件存放路径
+ 文件名

## 打开文件

先打开文件才能操作

`open`

### 参数：

+ 文件存放路径
+ 文件名
+ 要对文件的操作类型（读，写，读写）

### 功能：

1. 根据路径找到目录文件，判断权限
2. **复制到内存的打开文件表中**。**并将对应表目的编号返回给用户。**用户**使用打开文件的编号（文件描述符）**来指明要操作的文件

### 打开文件

+ **整个系统有一张打开文件表**
  + 有打开计数器，记录被几个进程打开了

+ **每个用户进程有一张打开文件表**
  + 有读写指针，用于记录文件已经读写到的位置

  + 访问权限（读写权限）

+ 如果该文件已经被打开了，则无法删除


## 关闭文件

+ 删除进程的打开文件表
+ 回收分配给该文件的内存空间资源
+ 系统打开文件表的计数器减一，如果为0则删除该表项

## 读文件

`read(int fd,buf(目的地址)，n（大小）)`

+ 提供文件在打开文件表中的索引号即可（索引号由之前的open获得）

+ 根据读指针，读入数据量，内存位置将**文件数据从外存读入内存**
  + 为什么是从外存读入到内存呢？之前打开的文件不是已经保存在内存了么

## 写文件

`write`

通过索引号进行操作，需要指明写出多少数据，写回外存的数据放在内存中的什么位置

# 文件保护

## 口令保护

+ 口令一般保存在FCB中。

+ 保存口令空间开销小，验证的时间也小

+ 正确的口令存放在系统内部，不够安全

## 加密保护

+ 使用密码对文件进行加密，提供正确的密码才能解密
+ 保密性强，不需要在系统中存储密码
+ 编码/译码，加密解密需要花费一定的时间

## 访问控制

在每个文件的FCB中增加一个**访问控制表**，该表记录了各个用户可以对该文件执行哪些操作。

+ 以组为单位，标记各组用户可以对文件执行哪些操作
  + 一个用户属于一个或多个组

# 文件的逻辑结构

>  操作系统可以支持记录式文件。但是绝大多数操作系统为简化实现，**一般在内核中支持流式文件。然后以库函数的方式在内核外实现记录式文件。**(换句话来说其实并无本质区别，只是用户视角的呈现不同)

## 无结构文件

流式文件.txt的形式

## 有结构文件

+ 每条记录有一个数据项可以作为关键字。

+ 有结构文件可以分为**定长记录**和**可变长记录**
  + 定长记录长度相同，且各数据项在记录中有相同的位置。
  + 某些数据项长度不确定，这就需要可变长记录

## 文件的逻辑组织结构（这个有什么实质意义吗？？？ 见后面解释）

### 顺序文件

#### 顺序存储

+ 逻辑上相邻的记录在物理上也相邻
+ 可变长无法随机存取，定长可以随机存取

#### 链式存储

+ 逻辑上相邻的元素在物理上不一定相邻(数据+指针)

+ 无法实现随机存取（无论是定长还是不定长，根本原因就是物理上不相邻），每次只能从第一个记录开始依次往后找

### 索引文件（看书）

在逻辑上看出文件是如何连接的

索引表的结构：索引号+长度m+指针ptr

+ 索引表本身是定长记录的顺序文件，一个表项就是一个定长的纪录，可以支持随机存取
+ 按关键字顺序排列，可以支持快速检索
+ 用于对信息处理的及时性要求较高的场合
+ 空间存储利用率较低（索引表本身就占据空间）

### 索引顺序文件

#### 可以建立多级索引表实现快速查找

实现方法类似于桶排序。例如将首字母为A的建立一个索引，将首字母为B的建立一个索引

# 文件的物理结构

在外存中，文件的逻辑地址也被分成一个个的文件块。

文件的逻辑地址可以表示为（逻辑块号，块内地址）。

操作系统为文件分配的存储空间都是以块为单位进行的。

操作系统负责将逻辑块号转化为物理块号。

## 连续分配

+ 连续分配要求文件**在磁盘上**占有**一组连续**的块。

+ 查找文件的目录项FCB(文件控制块)。

+ FCB包括**文件名，起始块号，长度（总共占有几个块）**
  + 文件名aaa，起始块号4，长度3

#### 问题1：操作系统如何实现从逻辑地址到物理地址的映射？

（逻辑块号，块内地址）->（物理块号，块内地址）

**物理块号=起始块号+逻辑地址**（有点像基址+变址。如果逻辑块号过长就是不合法的）

#### 问题2：顺序访问和直接访问（随机访问）的区别

顺序访问依次遍历其余的块，**而直接访问不需要依次经过别的块**。

连续分配支持顺序访问和直接访问（随机访问）。

#### 优点

**连续分配的文件在顺序读写时最快**（盘块相聚越远，查找的时间就越长）

连续分配支持顺序访问和直接访问（随机访问）。

#### 缺点

因为要求的是连续的空间，对文件的扩展很不方便。会产生碎片

## 链接分配

可以为文件分配离散的磁盘块。可以使用指针的方式将这些磁盘块串联起来。**一个文件用一个链表表示。**

### 隐式链接

**FCB的数据结构：**

文件名 起始块号 结束块号

#### 如何实现逻辑块号到物理块号的转变？

用户查找第i号磁盘块。共需进行i+1次磁盘IO。（从0号块开始，类似于链表，只支持顺序访问）

方便拓展文件。不会产生碎片问题。

### 显式链接

#### FAT表（文件分配表）：

**开机读入内存 常驻内存  一个磁盘只有一张**

记录了下一个块号

**数据结构：**

FCB表

文件名  起始块号

FAT表

一个物理块号 下一个物理块号

去Fat表中找下一个块号

#### 优点

支持顺序访问也支持随机访问。

随机访问：通过查FAT表的方式找到逻辑块对应的物理块，而不需要对磁盘进行访问。

## 索引分配

+ 文件离散的分配在磁盘中
+ 系统为**每个文件建立一个索引表**（实现逻辑页面到物理页面之间的映射）
+ 索引表存放的磁盘块叫做索引块。数据存放的磁盘块叫做数据块。
+ **支持随机访问和文件拓展**

### FCB的数据结构

文件名+索引块。索引块中存放的是索引表。

### 如何实现逻辑块到物理块的映射

1. 根据文件名找到索引块号。
2. 索引块号中取出索引表。
3. 根据索引表查找。

### 多层索引

方法参考多级页表

### 混合索引

直接索引+一级间接索引+二级间接索引

### 重要考点

+ 会根据多层索引、混合索引计算出文件的最大长度
+ 分析访问某个数据块需要的读取磁盘次数
  + 注意顶级索引是否已经调入内存

|                  | HOW                                                          | 目录项内容                           | 优点                                                         | 缺点                             |
| ---------------- | ------------------------------------------------------------ | ------------------------------------ | ------------------------------------------------------------ | -------------------------------- |
| 顺序分配         | 为文件分配的必须是连续的磁盘块                               | 起始块号、文件长度                   | 速度快，随机访问                                             | 产生碎片，不利于拓展             |
| 链接分配（隐式） | 除了最后一个盘块之外，**每个盘块都有指向下一个盘块的指针**   | 起始块号、结束块号                   | 结构型文件，我们假设一张数据表。逻辑上我可以对它顺序划分，即1-10划为一组。索引顺序文件，按照桶排序的方法来划分。就是你实际看到的形式。解决碎片问题，利用率高，文件拓展实现方便 | 只能顺序访问                     |
| 链接分配（显式） | 建立一张文件分配FAT表，显式记录盘块的先后关系（一个系统里面只有一张）。把用于连接各物理块的指针取出来，显示的放在内存的一张表中。 | 起始块号                             | 有隐式的优点。随机访问                                       | FAT占空间                        |
| 索引分配         | 为文件数据块建立索引表。若文件太大，可以采用链接方案，多层索引，混合索引。（类似与把文件用一个数组的形式组织起来） | 链接方案记录的是第一个索引块的块号。 | 支持随机访问，易于拓展                                       | 索引表占空间。多次磁盘读写工作。 |

注：连接方式不说明的话都是隐式

# 文件存储空间管理

## 存储空间管理——空闲表法

| 第一个空闲盘块号 | 空闲盘块数 |
| ---------------- | ---------- |
|                  |            |
|                  |            |
|                  |            |

分配磁盘块：可以采用首次适应，最佳适应，最坏适应等方法

回收磁盘块：和之前一样

## 存储空间管理——空闲链表法

### 空闲盘块链

+ 空闲盘块中存储着指向下一个空闲盘块的指针
+ 从链头分配K个空间进行分配
+ 将盘块挂到链尾进行回收结构型文件，我们假设一张数据表。逻辑上我可以对它顺序划分，即1-10划为一组。索引顺序文件，按照桶排序的方法来划分。就是你实际看到的形式。

### 空闲盘区链

+ 一个盘区可以包含多个盘块

+ 空闲盘区中的第一个盘块存储着盘区的长度和指向下一个空闲盘块的指针
+ 可以采用首次适应，最佳适应，最坏适应等方法找到复合的盘区。没有的话也可以多个盘区。

## 存储空间管理——位示图法

用一个二进制位表示。0表示盘块空闲。1表示不空闲。

## 存储空间管理——成组链接法

文件卷的目录区中专门用一个磁盘作为超级块。系统启动时将超级块读入内存。

？？没看懂

# 写在后面

## 文件的逻辑结构和物理结构辨析

可以实现物理上不同的存储方式对应不同的逻辑存储方式

**文件的逻辑结构单独形成一个文件进行存储。而文件的物理存储形式是保存在inode中的？**

https://blog.csdn.net/william_munch/article/details/85003699

> 我的理解：结构型文件，我们假设一张数据表。逻辑上我可以对它顺序划分，即1-10划为一组。索引顺序文件，按照桶排序的方法来划分。就是你实际看到的形式。一张excel表，可以有多种逻辑形式，比如说升序是一种形式，降序是一种形式。但在物理上的存储方式没有变

> 这里首先关注逻辑结构：实际上讲的就是在文件的内部，逻辑上数据是如何被组织起来的。

> 不管文件内部的记录是怎样被组织的，每一个记录被安排的位置反映的都是每一个记录对于整个文件的相对的位置。当整个文件按照某一种组织方式组织起来的时候，我们把它视为一个大的整体，不再考虑文件内部逻辑的组织，现在要考虑的是如何把这一个文件存入外存。

> 如“线性表”就是逻辑结构，其对应的“顺序表”和“链表”就是对应的“物理结构”
> 顺序表的各个元素在逻辑上相邻，在物理上也相邻；而链表在物理上是不相邻的。因此，顺序表可以实现**“随机访问”**，而“链表”无法实现随机访问。（**我的补充，用户是面向逻辑进行操作的，即使链表是物理上不相邻的，我依然可以按照线性表的方法进行操作。**）

> 不要过分深究到逻辑结构和物理结构中去

## FCB(文件描述符)与inonde的区别

![image-20220915162744259](https://raw.githubusercontent.com/Alemdx/pic-bed/master/math2/image-20220915162744259.png)

文件目录由FCB（目录项）组成

- FCB = 文件名 + inode号（所谓的Inode号其实是个指针）
- inode包含了文件物理地址信息
- 物理地址信息的组成主要是主索引表

## 文件系统概述

+ Linux 文件系统会为每个文件分配两个数据结构：索引节点（index node）和目录项（directory entry），它们主要用来**记录文件的元信息和目录层次结构**。
+ 一个FCB就是一个文件目录项。
+ **文件目录：把所有的FCB组织在一起**，就构成了文件目录，即文件控制块的有序集合；（Dentry是FCB的集合）
  目录文件：为了实现对文件目录的管理，通常将文件目录以文件的形式保持在外存，这个文件就叫目录文件。（本身也是一个文件。永远不为空。包含`.和..`子目录还有文件）
+ 数据块索引在union结构的每个具体文件系统中，其中的i_data[15] 数组给出数据块地址索引，前12项为直接索引，第13项为一次间接索引，第14项为二次间接索引，第15项为三次间接索引。
  + **由此可以看到Inode内部的Union集合体负责了文件的物理结构。**
  + 为什么是物理结构，因为文件本来就是在外存之中的。

### Inode

- 索引节点，也就是inode，**用来记录文件的元信息**，比如 inode 编号、文件大小、访问权限、创建时间、修改时间、数据在磁盘的位置等等。**索引节点是文件的唯一标识，它们之间一一对应**，也同样都会被存储在硬盘中，所以索引节点同样占用磁盘空间。

### Dentry

- **目录项**，也就是 dentry，用来**记录文件的名字**、**索引节点指针**以及**与其他目录项的层级关联关系**。多个目录项关联起来，就会形成目录结构，但它与索引节点不同的是，目录项是由内核维护的**一个数据结构**，不存放于磁盘，而是**缓存在内存**。

### Dentry和Inode的关系

https://www.sohu.com/a/413291356_115128

由于索引节点唯一标识一个文件，而**目录项记录着文件的名**，所以目录项和索引节点的关系是多对一

![image-20220915184115370](https://raw.githubusercontent.com/Alemdx/pic-bed/master/math2/image-20220915184115370.png)