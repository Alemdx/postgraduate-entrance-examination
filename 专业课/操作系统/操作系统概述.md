# OS的概念和功能

+ 向上提供接口

+ 对下层功能的扩展

+ 对系统资源的管理

# OS的发展与特征

+ 并发
+ 共享
+ 虚拟
+ 异步

**并发共享是最基本特征**

### 批处理系统

为了提高吞吐量和CPU的利用率

主要问题是缺少交互

### 分时操作系统

允许多个用户以交互的方式使用系统

采用时间片

不能抢占（也能抢占）

### 实时操作系统

能抢占

# OS的体系结构

## 大内核

**与微内核相比还保存了一些其他操作**。如进程管理，存储管理，设备管理等功能。

+ 性能高
+ 内核代码庞大，难以维护

## 微内核

**只保存与硬件最紧密的功能**。如中断处理、时钟管理、原语等。其他的在用户态下就可以运行。

+ 性能低
+ 内核代码少，易于维护

# 中断与异常

目态和管态分别对应用户态和核心态。

+ 有何作用
+ 有什么区别
+ 如何处理中断和异常

## 特权指令

这些情况都是出现在内核态

>  不允许用户直接使用的指令

IO指令、置中断指令、存取用于内存保护的寄存器、送程序状态字、程序状态字寄存器

**但是特别要注意，获得寄存器的内容，可以不经过系统调用。**

但是王道书上说，凡是与资源有关的操作，都要进过寄存器。

## 非特权指令

>  允许用户直接使用的指令

## 内核的组成

内核有两层：

+ 与硬件关联紧密的模块
  + 时钟管理
    + 功能一：计时
    + 功能二：中断驱动的进程切换
  + 中断管理
  + 设备驱动（这里是驱动）
+ 运行频次较高的程序
  + 进程管理
  + 存储管理
  + 设备管理（这边是管理，涉及调度）

## 原语

+ **原语是一种特殊的程序**，具有原子性。也就是说，这段程序的运行必须一气呵成，**不可被中断**。（即使有外部中断信号，也必须把这个执行完）
+ 最底层，最接近硬件
+ 直接的实现办法是关中断。(因为不可被中断嘛,把中断关了)

## 中断

**要注意，中断或异常会从用户态进入到内核态。中断或异常本身并不属于任何状态，只是一个trigger（这是靠硬件实现的）。**但是中断处理程序是在内核态进行的

又叫外中断

> 来自CPU执行指令外部的事件

+ 信息输入输出
+ IO中断
+ 时钟中断

发生中断时，操作系统并不保存中断程序的中断点，由PC保存。

## 异常

又叫内中断（执行的指令有问题）

> 来自CPU执行指令内部的事件

+ Fault
  + 非法操作码
  + 缺页故障
  + 除数为0
  + 运算溢出
+ Trap（访管，陷入）
  + 条件陷阱指令
+ Abort
  + 控制器出错
  + 存储器校验错误

### 特权指令的使用者是谁？

### 哪些指令是在核心态下使用的？

最常见的就是IO，

还有一些会导致中断异常的原因。

**这里千万注意，涉及到寄存器的操作，不应定要进入内核态。很多操作都可以经过寄存器实现。例如向内存中存取数据。**



# 系统调用

系统调用就是用户调用操作系统提供的子功能。**公共子程序。**

+ 有什么作用
+ 陷入指令？
+ 系统调用的过程

## 系统调用与库函数的区别

+ 操作系统向上提供系统调用，使得上层程序能够通过系统调用请求内核的服务(所以可以理解为系统调用包含于操作系统？那么页面置换算法是在哪呢应该和进程调度算法一样，但是不属于系统调用)
+ 普通应用程序**可以直接进行系统调用，也可以使用库函数**。有的库函数涉及系统调用，有的不涉及。（注意这里是应用程序而不是用户。用户不能直接进行系统调用。）
+ **编程语言向上提供库函数**。有时**会将系统调用封装成库函数**，以隐藏系统调用的一些细节，使得程序员编程更加方便。

注意：

**对共享资源的相关操作都要通过系统调用来实现。**

**陷入指令（TRAP/访管）是在用户态下执行的**。**执行陷入指令后引发一个内中断( 异常)，使CPU进入内核态。**

发起系统调用的请求是在用户态，而系统调用相应的处理是在内核态下。



# 操作系统的运行机制

内核程序

应用程序

刚开机的时候，cpu是在内核态，后面转变为应用程序（主动行为，让出CPU）。当发生中断或异常时，又变成了内核态。

# 常见的系统调用

说到底这些操作好像都和硬件有关。

1. **过程控制**

**a. 创建进程**

**b. 终止进程**

**c. 载入、执行**

d. 获取/设置过程属性

e. 等待时间、等待事件、信号事件

f. **分配和释放内存**

2. **文件管理**

**a. 建文件、删文件**

**b. 打开文件、关闭文件**

c. 读、写、调位置

d. 获取/设置文件属性

3. **设备管理**

a. 请求设器、释放设器

b. 读、写、调位位置

c. 获取/设置设备属性

d. 连接或断开设备

4. **信息维护**

**a. 获取/设定时间或日期**

**b. 获取/设置系统数据**

c. 获取/设置进程、文件或设备属性

5. **通信**

a. 建立、断开通信

b. 收发信息

c. 转移状态信息

d. 连接和断开远程设备

6. **保护措施**

a. 获取/设置权限

![image-20220913215407553](https://raw.githubusercontent.com/Alemdx/pic-bed/master/math2/image-20220913215407553.png)

![image-20220913215417762](https://raw.githubusercontent.com/Alemdx/pic-bed/master/math2/image-20220913215417762.png)

![image-20220913215431277](https://raw.githubusercontent.com/Alemdx/pic-bed/master/math2/image-20220913215431277.png)
